# SIR

SIR is a **streamable**, **record-oriented binary file format** with a **sparse index**.  
It is designed to efficiently locate blocks containing specific records, using a block-based storage structure and an index table.

## Motivation

We needed a way to stream simple log data (timestamp + message) generated by short-lived tasks to users in real time, and to efficiently retrieve specific log ranges after the task ends.
Our first target platform was the Web, so a lightweight implementation was preferred.

## Features

- **Indexed**: Uses a monotonically increasing unsigned 64-bit index for records.
- **Write Streamable**: Append-only structure for writing.
- **Read Streamable**: Efficiently locates blocks containing a specific index for reading.

## Layout

There are four sections: Header, Blocks, Index Table, and Footer.

### Header

```
   0      1      2      3      4      5      6      7      8
   .      .      .      .      .      .      .      .      .
00 |           Magic           | VER  | COMP |     RSV     |
08 |                    Content Length                     |
10 |                  Index Table Offset                   |
18 |                  First Block Offset                   |
20 |                       Metadata                        |
```

- **Magic**: A fixed constant to identify the file format. The first 4 bytes must be `0x53 0x49 0x52 0x00` (`SIR\0`).
- **VER**: SIR format version. Currently, only `0x01` is supported.
- **COMP**: Compression algorithm used for the payload. See [Compression Algorithms](#compression-algorithms).
- **Content Length**: Total size of the file, used to find the end of the file. It can be 0.
- **Index Table Offset**: Start position of the Index Table in the file. If 0, refer to the Footer section to find the Index Table offset.
- **First Block Offset**: Start position of the first Block in the file. If 0, refer to the Footer section.
- **Metadata**: Optional field for user-defined data.

### Payload

```
   0      1      2      3      4      5      6      7      8
   .      .      .      .      .      .      .      .      .
00 |           Size            |      Data (variable)      | # Record 1
                              ...                          
00 |           Size            |      Data (variable)      | # Record 2
                              ...                          
00 |           Size            |      Data (variable)      | # Record 3
                              ...                          
```

Payload is collection of the records.

- **Size**: Size of the data.
- **Data**: User data.

### Block

```
   0      1      2      3      4      5      6      7      8
   .      .      .      .      .      .      .      .      .
00 |      Compressed Size      |     Uncompressed Size     | # Block 1
08 |                  Payload (variable)                   | # Block 1
10 |                      Sync Marker                      |
18 |                      Sync Marker                      |
                              ...                          
00 |      Compressed Size      |     Uncompressed Size     | # Block 2
08 |                  Payload (variable)                   | # Block 2
10 |                      Sync Marker                      |
18 |                      Sync Marker                      |
                              ...                          
```

- **First Index**: The index of the first record in the block.
- **Uncompressed Size**: Original size of the payload if compressed.
- **Sync Marker**: Fixed constant to mark block boundaries:

   ```
      0    1    2    3    4    5    6    7    8
      .    .    .    .    .    .    .    .    .
   00 | 48 . 44 . 41 . 59 . 52 . 4F . 42 . 4F | HDAYROBO
   08 | 40 . 11 . DA . 70 . 80 . B0 . 71 . C2 |
   ```

#### Sealing Block

```
   0      1      2      3      4      5      6      7      8
   .      .      .      .      .      .      .      .      .
00 |    Compressed Size (0)    |   Uncompressed Size (0)   |
08 |                      Sync Marker                      |
10 |                      Sync Marker                      |
```

Sealing Block is a Block that does not hold a payload, so both **Compressed Size** and **Uncompressed Size** are zero.
When the reader encounters a Sealing Block, it stops reading.


### Index Table

```
      0      1      2      3      4      5      6      7      8
      .      .      .      .      .      .      .      .      .
   00 |                     First Index                       | # Group 1
   08 |                        Offset                         |
   10 |        Index Delta        |       Offset Delta        | # Delta 1
   18 |        Index Delta        |       Offset Delta        | # Delta 2
                                 ...
01 F8 |        Index Delta        |       Offset Delta        | # Delta 62 
02 00 |                     First Index                       | # Group 2
02 08 |                        Offset                         |
02 10 |        Index Delta        |       Offset Delta        | # Delta 1
02 18 |        Index Delta        |       Offset Delta        | # Delta 2
                                 ... 
04 00 |                     First Index                       | # Group 3
04 08 |                        Offset                         |
04 10 |        Index Delta        |       Offset Delta        | # Delta 1
04 18 |        Index Delta        |       Offset Delta        | # Delta 2
04 20 |                         Zeros                         | # Padding
04 20 |                         Zeros                         | # Padding
                                 ... 
05 F8 |                         Zeros                         | # Padding
```

The Index Table records the location of each block in the file.
It is divided into groups, each with one absolute position and 62 delta positions.
The absolute position indicates the first index value of the block and its file offset; deltas are used to incrementally calculate the positions of subsequent blocks.

### Footer

```
   0      1      2      3      4      5      6      7      8
   .      .      .      .      .      .      .      .      .
00 |                  Index Table Offset                   |
08 |           Magic           |
```

- **Index Table Offset**: Start position of the Index Table in the file.
- **Magic**: A fixed constant to identify the end of file. The last 4 bytes must be `0x53 0x49 0x52 0x00` (`SIR\0`).

## Compression Algorithms

| Value  | Algorithm |
| ------ | --------- |
| `0x00` | None      |
| `0x01` | Deflate   |
| `0x02` | Brotli    |
| `0x03` | LZ4       |
| `0x04` | Snappy    |
| `0x05` | Zstandard |

## Empty File

```
      0      1      2      3      4      5      6      7      8
      .      .      .      .      .      .      .      .      .
   00 |           Magic           | VER  | COMP |     RSV     |
   08 |                    Content Length                     |
   10 |                  Index Table Offset                   |
   18 |                  First Block Offset                   |
   20 |    Compressed Size (0)    |   Uncompressed Size (0)   |
   28 |                      Sync Marker                      |
   30 |                      Sync Marker                      |
   38 |                 Empty Index Table (0)                 |
      |                   (504 zeros more)                    |
02 38 |                  Index Table Offset                   |
02 40 |           Magic           |
```

Empty File does not contain any payload, but it should include a Seal Block and an empty Index Table to simplify the reader implementation.
Metadata can be included in the header, but the diagram omits it.
